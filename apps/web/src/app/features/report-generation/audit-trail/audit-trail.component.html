<!-- Audit Trail Section -->
<div id="audit" class="audit-trail-section polished-card">
  <!-- Notification Banner -->
  <div *ngIf="showNotification" class="audit-notification">
    <i class="fas fa-info-circle"></i>
    <span>{{ notificationMessage }}</span>
    <button class="close-btn" (click)="showNotification = false" title="Dismiss notification">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="section-header polished-header">
    <div class="header-title">
      <i class="fas fa-history"></i>
      <h2>Audit Trail</h2>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" (click)="exportAuditTrail()" [disabled]="auditTrails.length === 0" title="Export all logs">
        <i class="fas fa-download"></i>
        Export Logs
      </button>
      <button class="btn-danger" (click)="clearAuditTrail()" [disabled]="auditTrails.length === 0" title="Clear all logs">
        <i class="fas fa-trash"></i>
        Clear All
      </button>
    </div>
  </div>

  <!-- Audit Trail Filters -->
  <div class="audit-filters polished-filters">
    <div class="filters-grid">
      <div class="filter-item">
        <label>Date Range</label>
        <select class="form-control" [(ngModel)]="auditFilters.dateRange">
          <option value="">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
          <option value="quarter">This Quarter</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Department</label>
        <select class="form-control" [(ngModel)]="auditFilters.department">
          <option value="">All Departments</option>
          <option value="HR">Human Resources</option>
          <option value="Finance">Finance</option>
          <option value="IT">IT Department</option>
          <option value="Operations">Operations</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Action</label>
        <select class="form-control" [(ngModel)]="auditFilters.action">
          <option value="">All Actions</option>
          <option value="generated">Generated</option>
          <option value="exported">Exported</option>
          <option value="printed">Printed</option>
          <option value="deleted">Deleted</option>
          <option value="modified">Modified</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Status</label>
        <select class="form-control" [(ngModel)]="auditFilters.status">
          <option value="">All Status</option>
          <option value="success">Success</option>
          <option value="failed">Failed</option>
          <option value="pending">Pending</option>
        </select>
      </div>
      <div class="filter-item">
        <label>Report Type</label>
        <select class="form-control" [(ngModel)]="auditFilters.reportType">
          <option value="">All Types</option>
          <option value="employee">Employee</option>
          <option value="payroll">Payroll</option>
          <option value="attendance">Attendance</option>
          <option value="leave">Leave</option>
          <option value="performance">Performance</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="filter-item">
        <button class="btn-primary" (click)="filterAuditTrails()" [disabled]="auditTrails.length === 0">
          <i class="fas fa-filter"></i>
          Apply Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Audit Trail Table -->
  <div class="audit-table">
    <!-- Empty State -->
    <div *ngIf="auditTrails.length === 0" class="empty-state polished-empty">
      <div class="empty-state-content">
        <i class="fas fa-history empty-icon"></i>
        <h3>No Audit Trail Records</h3>
        <p>Audit trail entries will appear here when you successfully export reports (CSV, Excel, PDF) from the main report generation section.</p>
      </div>
    </div>

    <!-- Table with Data -->
    <div *ngIf="auditTrails.length > 0" class="table-container polished-table">
      <table>
        <thead>
          <tr>
            <th>Action</th>
            <th>Report Name</th>
            <th>Format</th>
            <th>Generated By</th>
            <th>Department</th>
            <th>Date & Time</th>
            <th>Status</th>
            <th>File Size</th>
            <!--<th>Downloads</th>-->
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let audit of auditTrails" tabindex="0" title="View details">
            <td>
              <div class="action-cell">
                <i [class]="getActionIcon(audit.action)" 
                   [style.color]="getActionColor(audit.action)"
                   [title]="audit.action | titlecase"></i>
                <span class="action-text">{{ audit.action }}</span>
              </div>
            </td>
            <td>
              <div class="report-info">
                <span class="report-name">{{ audit.reportName }}</span>
                <span class="report-type">{{ audit.reportType }}</span>
              </div>
            </td>
            <td>
              <div *ngIf="audit.exportFormat" class="format-cell">
                <i [class]="getFormatIcon(audit.exportFormat)" 
                   [style.color]="getFormatColor(audit.exportFormat)"
                   [title]="audit.exportFormat.toUpperCase()"></i>
                <span class="format-text">{{ audit.exportFormat.toUpperCase() }}</span>
              </div>
              <span *ngIf="!audit.exportFormat" class="no-format">-</span>
            </td>
            <td>
              <div class="user-info">
                <span class="user-email">{{ audit.generatedBy }}</span>
                <span class="ip-address">{{ audit.ipAddress }}</span>
              </div>
            </td>
            <td>
              <span class="department-badge">{{ audit.department }}</span>
            </td>
            <td>
              <div class="datetime-info">
                <span class="datetime">{{ formatDate(audit.generatedAt) }}</span>
                <span class="time-ago">{{ getTimeAgo(audit.generatedAt) }}</span>
              </div>
            </td>
            <td>
              <div class="status-cell">
                <i [class]="getStatusIcon(audit.status)" 
                   [style.color]="getStatusColor(audit.status)"
                   [title]="audit.status | titlecase"></i>
                <span class="status-text">{{ audit.status }}</span>
              </div>
            </td>
            <td>
              <span class="file-size">{{ audit.fileSize }}</span>
            </td>
            <!--<td>
              <span class="download-count">{{ audit.downloadCount }}</span>
            </td>-->
            <td>
              <div class="audit-actions">
                <button class="btn-icon" title="View Details" (click)="viewAuditTrail(audit)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-icon" 
                        (click)="deleteAuditTrail(audit.id)"
                        title="Delete Record">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Table Footer -->
    <div *ngIf="auditTrails.length > 0" class="table-footer">
      <div class="pagination">
        <button class="btn-page" disabled title="Previous page">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="page-info">Page 1 of 1</span>
        <button class="btn-page" disabled title="Next page">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="page-size">
        <span>Show:</span>
        <select class="form-control">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span>entries</span>
      </div>
    </div>
  </div>

  <!-- View Audit Trail Modal -->
  <div class="modal" *ngIf="showViewModal">
    <div class="modal-overlay" (click)="closeViewModal()"></div>
    <div class="modal-content audit-modal-animate">
      <div class="modal-header improved-modal-header">
        <div class="header-left">
          <span class="modal-icon"><i [class]="getActionIcon(selectedAudit?.action || '')" [style.color]="getActionColor(selectedAudit?.action || '')"></i></span>
          <div>
            <h2>Audit Trail Details</h2>
            <div class="modal-subtitle">
              <span *ngIf="selectedAudit?.exportFormat as format" class="format-badge">
                <i [class]="getFormatIcon(format)"></i>
                {{ format.toUpperCase() }}
              </span>
              Full log information
            </div>
          </div>
        </div>
        <button class="btn-icon close-btn-lg" (click)="closeViewModal()" title="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body improved-modal-body" *ngIf="selectedAudit">
        <!-- Basic Information -->
        <div class="audit-detail-grid">
          <div class="audit-detail-row">
            <span class="label">Action:</span>
            <span><span class="badge-action" [style.background]="getActionColor(selectedAudit.action)"><i [class]="getActionIcon(selectedAudit.action)"></i> {{ selectedAudit.action }}</span></span>
          </div>
          <div class="audit-detail-row">
            <span class="label">Status:</span>
            <span><span class="badge-status" [style.background]="getStatusColor(selectedAudit.status)"><i [class]="getStatusIcon(selectedAudit.status)"></i> {{ selectedAudit.status }}</span></span>
          </div>
          <div class="audit-detail-row"><span class="label">Report Name:</span> <span>{{ selectedAudit.reportName }}</span></div>
          <div class="audit-detail-row"><span class="label">Report Type:</span> <span>{{ selectedAudit.reportType }}</span></div>
          <div class="audit-detail-row"><span class="label">Generated By:</span> <span>{{ selectedAudit.generatedBy }}</span></div>
          <div class="audit-detail-row"><span class="label">Department:</span> <span>{{ selectedAudit.department }}</span></div>
          <div class="audit-detail-row"><span class="label">Date & Time:</span> <span>{{ formatDate(selectedAudit.generatedAt) }}</span></div>
          <div class="audit-detail-row"><span class="label">File Size:</span> <span>{{ selectedAudit.fileSize }}</span></div>
          <div class="audit-detail-row"><span class="label">Download Count:</span> <span>{{ selectedAudit.downloadCount }}</span></div>
          <div class="audit-detail-row"><span class="label">IP Address:</span> <span>{{ selectedAudit.ipAddress }}</span></div>
          <div class="audit-detail-row"><span class="label">User Agent:</span> <span>{{ selectedAudit.userAgent }}</span></div>
          <div class="audit-detail-row"><span class="label">Filters:</span> <span>{{ selectedAudit.filters.join(', ') }}</span></div>
          <div class="audit-detail-row"><span class="label">Template Used:</span> <span>{{ selectedAudit.templateUsed }}</span></div>
        </div>

        <!-- Report Data Section -->
        <div *ngIf="selectedAudit.reportData" class="report-data-section">
          <div class="section-divider">
            <h3><i class="fas fa-table"></i> Report Data Preview</h3>
            <div class="report-summary">
              <span class="summary-item">
                <i class="fas fa-file-alt"></i>
                {{ selectedAudit.reportData.totalRecords }} records
              </span>
              <span *ngIf="selectedAudit.reportData.totalValue" class="summary-item">
                <i class="fas fa-calculator"></i>
                Total: {{ selectedAudit.reportData.totalValue }}
              </span>
              <span *ngIf="selectedAudit.exportFormat" class="summary-item">
                <i [class]="getFormatIcon(selectedAudit.exportFormat)"></i>
                {{ selectedAudit.exportFormat.toUpperCase() }} format
              </span>
            </div>
          </div>

          <!-- Report Metadata -->
          <div *ngIf="selectedAudit.reportMetadata" class="metadata-section">
            <h4>Report Metadata</h4>
            <div class="metadata-grid">
              <div class="metadata-item">
                <span class="metadata-label">Date Range:</span>
                <span class="metadata-value">{{ selectedAudit.reportMetadata.dateRange }}</span>
              </div>
              <div class="metadata-item">
                <span class="metadata-label">Department:</span>
                <span class="metadata-value">{{ selectedAudit.reportMetadata.department }}</span>
              </div>
              <div class="metadata-item">
                <span class="metadata-label">Report Type:</span>
                <span class="metadata-value">{{ selectedAudit.reportMetadata.reportType }}</span>
              </div>
              <div class="metadata-item">
                <span class="metadata-label">Applied Filters:</span>
                <span class="metadata-value">{{ selectedAudit.reportMetadata.appliedFilters.join(', ') }}</span>
              </div>
            </div>
          </div>

          <!-- Data Table -->
          <div class="data-table-section">
            <h4>Data Preview</h4>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th *ngFor="let header of selectedAudit.reportData.headers">{{ header }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of selectedAudit.reportData.rows.slice(0, 10)">
                    <td *ngFor="let cell of row">{{ cell }}</td>
                  </tr>
                  <tr *ngIf="selectedAudit.reportData.rows.length > 10" class="more-rows">
                    <td [attr.colspan]="selectedAudit.reportData.headers.length">
                      <i class="fas fa-ellipsis-h"></i>
                      Showing first 10 of {{ selectedAudit.reportData.rows.length }} rows
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Format-specific Information -->
          <div *ngIf="selectedAudit.exportFormat" class="format-info">
            <h4>Export Format Details</h4>
            <div class="format-details">
              <div class="format-detail-item">
                <span class="format-label">Format:</span>
                <span class="format-value">
                  <i [class]="getFormatIcon(selectedAudit.exportFormat)"></i>
                  {{ selectedAudit.exportFormat.toUpperCase() }}
                </span>
              </div>
              <div class="format-detail-item">
                <span class="format-label">File Size:</span>
                <span class="format-value">{{ selectedAudit.fileSize }}</span>
              </div>
              <div class="format-detail-item">
                <span class="format-label">Records Exported:</span>
                <span class="format-value">{{ selectedAudit.reportData.totalRecords }}</span>
              </div>
              <div class="format-detail-item">
                <span class="format-label">Columns:</span>
                <span class="format-value">{{ selectedAudit.reportData.headers.length }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" (click)="closeViewModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>
