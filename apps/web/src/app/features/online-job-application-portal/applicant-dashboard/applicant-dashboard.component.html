<app-header *ngIf="publicMode" [publicMode]="publicMode" class="job-portal-header" [class.header-hidden]="!isHeaderVisible"></app-header>

<div class="dashboard-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-overlay" role="status" aria-label="Loading dashboard">
    <div class="loading-spinner">
      <span class="material-symbols-outlined" aria-hidden="true">refresh</span>
      <p>Loading your dashboard...</p>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <nav class="dashboard-nav" role="navigation" aria-label="Dashboard navigation">
    <div class="nav-container">
      <button 
        class="nav-tab" 
        [class.active]="currentView === 'overview'"
        (click)="onViewChange('overview')"
        [attr.aria-current]="currentView === 'overview' ? 'page' : null"
        aria-label="Overview dashboard"
      >
        <span class="material-symbols-outlined" aria-hidden="true">dashboard</span>
        Overview
      </button>
      <button 
        class="nav-tab" 
        [class.active]="currentView === 'applications'"
        (click)="onViewChange('applications')"
        [attr.aria-current]="currentView === 'applications' ? 'page' : null"
        aria-label="Applications management"
      >
        <span class="material-symbols-outlined" aria-hidden="true">work</span>
        Applications
      </button>
      <button 
        class="nav-tab" 
        [class.active]="currentView === 'profile'"
        (click)="onViewChange('profile')"
        [attr.aria-current]="currentView === 'profile' ? 'page' : null"
        aria-label="Profile settings"
      >
        <span class="material-symbols-outlined" aria-hidden="true">person</span>
        Profile
      </button>
      <button 
        class="nav-tab" 
        [class.active]="currentView === 'settings'"
        (click)="onViewChange('settings')"
        [attr.aria-current]="currentView === 'settings' ? 'page' : null"
        aria-label="Account settings"
      >
        <span class="material-symbols-outlined" aria-hidden="true">settings</span>
        Settings
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="dashboard-content" role="main">
    <!-- Overview View -->
    <section *ngIf="currentView === 'overview'" class="overview-view" aria-label="Dashboard overview">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-content">
          <h1 class="welcome-title">Welcome back, Applicant!</h1>
          <p class="welcome-subtitle">Track your job applications and stay updated with your progress</p>
          <div class="success-rate" *ngIf="stats.successRate > 0">
            <span class="success-label">Success Rate:</span>
            <span class="success-percentage">{{ stats.successRate }}%</span>
          </div>
        </div>
        <button class="browse-jobs-btn" (click)="browseJobs()" aria-label="Browse more job opportunities">
          <span class="material-symbols-outlined" aria-hidden="true">search</span>
          Browse More Jobs
        </button>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid" role="region" aria-label="Application statistics">
        <div class="stat-card total" role="article">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">work</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.totalApplications }}</h3>
            <p class="stat-label">Total Applications</p>
          </div>
        </div>

        <div class="stat-card pending" role="article">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">schedule</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.pendingReview }}</h3>
            <p class="stat-label">Pending Review</p>
          </div>
        </div>

        <div class="stat-card shortlisted" role="article">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">star</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.shortlisted }}</h3>
            <p class="stat-label">Shortlisted</p>
          </div>
        </div>

        <div class="stat-card interviews" (click)="goToInterviews()" style="cursor:pointer;" role="button" tabindex="0" aria-label="View interview schedule">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">event</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.interviews }}</h3>
            <p class="stat-label">Interviews</p>
          </div>
        </div>

        <div class="stat-card accepted" role="article">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">check_circle</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.accepted }}</h3>
            <p class="stat-label">Accepted</p>
          </div>
        </div>

        <div class="stat-card rejected" role="article">
          <div class="stat-icon" aria-hidden="true">
            <span class="material-symbols-outlined">cancel</span>
          </div>
          <div class="stat-content">
            <h3 class="stat-number">{{ stats.rejected }}</h3>
            <p class="stat-label">Rejected</p>
          </div>
        </div>
      </div>

      <!-- Recent Applications & Activity -->
      <div class="overview-grid">
        <!-- Recent Applications -->
        <div class="overview-card applications-card" role="region" aria-label="Recent applications">
          <div class="card-header">
            <h2 class="card-title">Recent Applications</h2>
            <button class="view-all-btn" (click)="onViewChange('applications')" aria-label="View all applications">
              View All
              <span class="material-symbols-outlined" aria-hidden="true">arrow_forward</span>
            </button>
          </div>
          <div class="applications-list">
            <div *ngFor="let app of applications.slice(0, 3)" class="application-item" role="article">
              <div class="app-info">
                <h3 class="app-title">{{ app.jobTitle }}</h3>
                <p class="app-company">{{ app.company }} • {{ app.department }}</p>
                <p class="app-location" *ngIf="app.location">
                  <span class="material-symbols-outlined" aria-hidden="true">location_on</span>
                  {{ app.location }}
                </p>
                <p class="app-date">Applied {{ formatDate(app.applicationDate) }}</p>
                
                <!-- Progress Bar -->
                <div class="progress-container" *ngIf="app.status !== 'rejected' && app.status !== 'accepted'">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="getApplicationProgress(app)"></div>
                  </div>
                  <span class="progress-text">{{ getApplicationProgress(app) | number:'1.0-0' }}% Complete</span>
                </div>
              </div>
              <div class="app-status">
                <span 
                  class="status-badge" 
                  [style.background-color]="getStatusColor(app.status)"
                  [attr.aria-label]="'Status: ' + getStatusLabel(app.status)"
                >
                  {{ getStatusLabel(app.status) }}
                </span>
                <div class="expiry-warning" *ngIf="isApplicationExpired(app)">
                  <span class="material-symbols-outlined" aria-hidden="true">warning</span>
                  <span>Expired</span>
                </div>
              </div>
            </div>
            <div *ngIf="applications.length === 0" class="empty-state">
              <span class="material-symbols-outlined" aria-hidden="true">work_off</span>
              <p>No applications yet</p>
              <button class="browse-btn" (click)="browseJobs()">Browse Jobs</button>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="overview-card activity-card" role="region" aria-label="Recent activity">
          <div class="card-header">
            <h2 class="card-title">Recent Activity</h2>
          </div>
          <div class="activity-list">
            <div *ngFor="let activity of recentActivities.slice(0, 4)" class="activity-item" role="article">
              <div class="activity-icon" [style.background-color]="getActivityColor(activity.type)" aria-hidden="true">
                <span class="material-symbols-outlined">{{ getActivityIcon(activity.type) }}</span>
              </div>
              <div class="activity-content">
                <h4 class="activity-title">{{ activity.title }}</h4>
                <p class="activity-description">{{ activity.description }}</p>
                <span class="activity-time">{{ getTimeAgo(activity.timestamp) }}</span>
              </div>
            </div>
            <div *ngIf="recentActivities.length === 0" class="empty-state">
              <span class="material-symbols-outlined" aria-hidden="true">notifications_off</span>
              <p>No recent activity</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Applications View -->
    <section *ngIf="currentView === 'applications'" class="applications-view" aria-label="Applications management">
      <div class="view-header">
        <h1 class="view-title">My Applications</h1>
        <div class="view-actions">
          <div class="search-box">
            <span class="material-symbols-outlined" aria-hidden="true">search</span>
            <input 
              type="text" 
              [(ngModel)]="searchTerm" 
              (input)="onSearch()"
              placeholder="Search applications..."
              class="search-input"
              aria-label="Search applications"
            >
          </div>
          <div class="filter-dropdown">
            <select [(ngModel)]="selectedFilter" (change)="onFilterChange(selectedFilter)" class="filter-select" aria-label="Filter by status">
              <option value="all">All Status</option>
              <option value="pending">Pending Review</option>
              <option value="reviewing">Under Review</option>
              <option value="shortlisted">Shortlisted</option>
              <option value="interviewed">Interviewed</option>
              <option value="rejected">Rejected</option>
              <option value="accepted">Accepted</option>
            </select>
          </div>
        </div>
      </div>

      <div class="applications-table" role="table" aria-label="Applications list">
        <div class="table-header" role="row">
          <div class="header-cell" role="columnheader">Job Title</div>
          <div class="header-cell" role="columnheader">Company</div>
          <div class="header-cell" role="columnheader">Applied Date</div>
          <div class="header-cell" role="columnheader">Status</div>
          <div class="header-cell" role="columnheader">Last Updated</div>
          <div class="header-cell" role="columnheader">Actions</div>
        </div>

        <div *ngFor="let app of filteredApplications" class="table-row" role="row">
          <div class="table-cell job-info" role="cell">
            <h3 class="job-title">{{ app.jobTitle }}</h3>
            <p class="job-department">{{ app.department }}</p>
            <p class="job-salary">{{ app.salaryRange }} • {{ getEmploymentTypeLabel(app.employmentType) }}</p>
            <p class="job-location" *ngIf="app.location">
              <span class="material-symbols-outlined" aria-hidden="true">location_on</span>
              {{ app.location }}
            </p>
          </div>
          <div class="table-cell" role="cell">
            <span class="company-name">{{ app.company }}</span>
          </div>
          <div class="table-cell" role="cell">
            <span class="date">{{ formatDate(app.applicationDate) }}</span>
          </div>
          <div class="table-cell" role="cell">
            <span 
              class="status-badge" 
              [style.background-color]="getStatusColor(app.status)"
              [attr.aria-label]="'Status: ' + getStatusLabel(app.status)"
            >
              {{ getStatusLabel(app.status) }}
            </span>
            <div class="expiry-warning" *ngIf="isApplicationExpired(app)">
              <span class="material-symbols-outlined" aria-hidden="true">warning</span>
              <span>Expired</span>
            </div>
          </div>
          <div class="table-cell" role="cell">
            <span class="date">{{ formatDate(app.lastUpdated) }}</span>
          </div>
          <div class="table-cell actions" role="cell">
            <button class="action-btn view-btn" (click)="viewApplication(app)" aria-label="View application details">
              <span class="material-symbols-outlined" aria-hidden="true">visibility</span>
            </button>
            <button class="action-btn withdraw-btn" (click)="withdrawApplication(app)" aria-label="Withdraw application">
              <span class="material-symbols-outlined" aria-hidden="true">delete</span>
            </button>
          </div>
        </div>

        <div *ngIf="filteredApplications.length === 0" class="empty-state">
          <span class="material-symbols-outlined" aria-hidden="true">search_off</span>
          <h3>No applications found</h3>
          <p>Try adjusting your search or filter criteria</p>
          <button class="browse-btn" (click)="browseJobs()">Browse Jobs</button>
        </div>
      </div>
    </section>

    <!-- Profile View -->
    <section *ngIf="currentView === 'profile'" class="profile-view" aria-label="Profile information">
      <div class="profile-header">
        <h1 class="view-title">My Profile</h1>
        <button class="edit-profile-btn" aria-label="Edit profile information">
          <span class="material-symbols-outlined" aria-hidden="true">edit</span>
          Edit Profile
        </button>
      </div>
      
      <div class="profile-content">
        <div class="profile-card">
          <div class="profile-avatar" aria-hidden="true">
            <span class="material-symbols-outlined">person</span>
          </div>
          <div class="profile-info">
            <h2 class="profile-name">John Doe</h2>
            <p class="profile-email">john.doe&#64;email.com</p>
            <p class="profile-phone">+63 912 345 6789</p>
            <div class="profile-stats">
              <span class="stat-item">
                <strong>{{ stats.totalApplications }}</strong> Applications
              </span>
              <span class="stat-item">
                <strong>{{ stats.successRate }}%</strong> Success Rate
              </span>
            </div>
          </div>
        </div>

        <div class="profile-sections">
          <div class="profile-section">
            <h3 class="section-title">Personal Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <label>Full Name</label>
                <span>John Michael Doe</span>
              </div>
              <div class="info-item">
                <label>Date of Birth</label>
                <span>January 15, 1990</span>
              </div>
              <div class="info-item">
                <label>Address</label>
                <span>123 Main Street, Quezon City, Metro Manila</span>
              </div>
              <div class="info-item">
                <label>Nationality</label>
                <span>Filipino</span>
              </div>
            </div>
          </div>

          <div class="profile-section">
            <h3 class="section-title">Education</h3>
            <div class="education-item">
              <h4>Bachelor of Science in Computer Science</h4>
              <p>University of the Philippines</p>
              <p>2010 - 2014</p>
              <p class="gpa">GPA: 3.8/4.0</p>
            </div>
          </div>

          <div class="profile-section">
            <h3 class="section-title">Skills</h3>
            <div class="skills-list">
              <span class="skill-tag">JavaScript</span>
              <span class="skill-tag">TypeScript</span>
              <span class="skill-tag">Angular</span>
              <span class="skill-tag">React</span>
              <span class="skill-tag">Node.js</span>
              <span class="skill-tag">Python</span>
              <span class="skill-tag">SQL</span>
              <span class="skill-tag">Git</span>
            </div>
          </div>

          <div class="profile-section">
            <h3 class="section-title">Work Experience</h3>
            <div class="experience-item">
              <h4>Senior Software Developer</h4>
              <p>Tech Solutions Inc.</p>
              <p>2020 - Present</p>
              <p>Led development of web applications using modern technologies</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings View -->
    <section *ngIf="currentView === 'settings'" class="settings-view" aria-label="Account settings">
      <div class="settings-header">
        <h1 class="view-title">Settings</h1>
      </div>
      
      <div class="settings-content">
        <div class="settings-section">
          <h3 class="section-title">Account Settings</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Email Notifications</h4>
              <p>Receive updates about your applications</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" checked aria-label="Enable email notifications">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <h4>SMS Notifications</h4>
              <p>Receive SMS updates about interviews</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" aria-label="Enable SMS notifications">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <h4>Application Reminders</h4>
              <p>Get reminders for application deadlines</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" checked aria-label="Enable application reminders">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3 class="section-title">Privacy</h3>
          <div class="setting-item">
            <div class="setting-info">
              <h4>Profile Visibility</h4>
              <p>Allow employers to view your profile</p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" checked aria-label="Enable profile visibility">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="settings-section">
          <h3 class="section-title">Account Actions</h3>
          <div class="action-buttons">
            <button class="action-btn secondary" aria-label="Change password">Change Password</button>
            <button class="action-btn secondary" aria-label="Export account data">Export Data</button>
            <button class="action-btn danger" aria-label="Delete account">Delete Account</button>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Application Details Modal -->
<div *ngIf="showApplicationModal" class="modal-overlay" (click)="closeApplicationModal()" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 id="modal-title" class="modal-title">Application Details</h2>
      <button class="modal-close-btn" (click)="closeApplicationModal()" aria-label="Close modal">
        <span class="material-symbols-outlined" aria-hidden="true">close</span>
      </button>
    </div>
    
    <div class="modal-body" *ngIf="selectedApplication">
      <!-- Application Header -->
      <div class="application-header">
        <div class="job-title-section">
          <h3 class="modal-job-title">{{ selectedApplication.jobTitle }}</h3>
          <p class="modal-company">{{ selectedApplication.company }}</p>
          <p class="modal-department">{{ selectedApplication.department }}</p>
          <p class="modal-location" *ngIf="selectedApplication.location">
            <span class="material-symbols-outlined" aria-hidden="true">location_on</span>
            {{ selectedApplication.location }}
          </p>
        </div>
        <div class="status-section">
          <span 
            class="modal-status-badge" 
            [style.background-color]="getStatusColor(selectedApplication.status)"
          >
            {{ getStatusLabel(selectedApplication.status) }}
          </span>
          <div class="expiry-warning" *ngIf="isApplicationExpired(selectedApplication)">
            <span class="material-symbols-outlined" aria-hidden="true">warning</span>
            <span>Application Expired</span>
          </div>
        </div>
      </div>

      <!-- Application Details Grid -->
      <div class="details-grid">
        <div class="detail-item">
          <label>Application Date</label>
          <span>{{ formatDate(selectedApplication.applicationDate) }}</span>
        </div>
        <div class="detail-item">
          <label>Last Updated</label>
          <span>{{ formatDate(selectedApplication.lastUpdated) }}</span>
        </div>
        <div class="detail-item">
          <label>Application Deadline</label>
          <span>{{ formatDate(selectedApplication.applicationDeadline) }}</span>
        </div>
        <div class="detail-item">
          <label>Salary Range</label>
          <span>{{ selectedApplication.salaryRange }}</span>
        </div>
        <div class="detail-item">
          <label>Employment Type</label>
          <span>{{ getEmploymentTypeLabel(selectedApplication.employmentType) }}</span>
        </div>
        <div class="detail-item" *ngIf="selectedApplication.time">
          <label>Interview Time</label>
          <span>{{ selectedApplication.time }}</span>
        </div>
      </div>

      <!-- Job Description -->
      <div class="description-section" *ngIf="selectedApplication.description">
        <h4 class="section-title">Job Description</h4>
        <p class="job-description">{{ selectedApplication.description }}</p>
      </div>

      <!-- Requirements -->
      <div class="requirements-section" *ngIf="selectedApplication.requirements?.length">
        <h4 class="section-title">Requirements</h4>
        <div class="requirements-list">
          <span *ngFor="let requirement of selectedApplication.requirements" class="requirement-tag">
            {{ requirement }}
          </span>
        </div>
      </div>

      <!-- Application Timeline -->
      <div class="timeline-section">
        <h4 class="section-title">Application Timeline</h4>
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h5>Application Submitted</h5>
              <p>{{ formatDateTime(selectedApplication.applicationDate) }}</p>
            </div>
          </div>
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <h5>Status Updated</h5>
              <p>{{ formatDateTime(selectedApplication.lastUpdated) }}</p>
              <span class="status-note">Current status: {{ getStatusLabel(selectedApplication.status) }}</span>
            </div>
          </div>
          <div class="timeline-item" *ngIf="selectedApplication.status === 'interviewed'">
            <div class="timeline-marker interview"></div>
            <div class="timeline-content">
              <h5>Interview Scheduled</h5>
              <p>{{ selectedApplication.time }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="modal-actions">
        <button class="action-btn secondary" (click)="closeApplicationModal()">
          Close
        </button>
        <button 
          class="action-btn danger" 
          (click)="withdrawApplication(selectedApplication); closeApplicationModal()"
          *ngIf="selectedApplication.status !== 'rejected' && selectedApplication.status !== 'accepted'"
        >
          <span class="material-symbols-outlined" aria-hidden="true">delete</span>
          Withdraw
        </button>
      </div>
    </div>
  </div>
</div>
